#!/usr/bin/env node
'use strict';

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');
const os = require('os');

function pkgNameForPlatform() {
  const platform = os.platform();
  const arch = os.arch();

  const platformMap = { linux: 'linux', darwin: 'darwin', win32: 'win32' };
  const archMap = { x64: 'x64', arm64: 'arm64' };

  const p = platformMap[platform];
  const a = archMap[arch];

  if (!p || !a) {
    throw new Error(
      `mdmend: unsupported platform/arch: ${platform}/${arch}\n` +
      `Supported: linux/x64, linux/arm64, darwin/x64, darwin/arm64, win32/x64\n` +
      `Install directly: https://github.com/mohitmishra786/mdmend/releases`
    );
  }

  return `@mohitmishra7/mdmend-${p}-${a}`;
}

function binaryName() {
  return os.platform() === 'win32' ? 'mdmend.exe' : 'mdmend';
}

function findBinary() {
  const pkgName = pkgNameForPlatform();

  try {
    const pkgDir = path.dirname(require.resolve(`${pkgName}/package.json`));
    const binPath = path.join(pkgDir, 'bin', binaryName());
    if (fs.existsSync(binPath)) return binPath;
  } catch (_) {}

  throw new Error(
    `mdmend: could not find binary for ${pkgName}.\n\n` +
    `The optional package "${pkgName}" is not installed.\n` +
    `Try: npm install --include=optional\n\n` +
    `Or install directly:\n` +
    `  https://github.com/mohitmishra786/mdmend/releases\n` +
    `  curl -fsSL https://raw.githubusercontent.com/mohitmishra786/mdmend/main/scripts/install.sh | sh`
  );
}

try {
  const binary = findBinary();
  try {
    execFileSync(binary, process.argv.slice(2), { stdio: 'inherit' });
  } catch (e) {
    process.exit(e.status != null ? e.status : 1);
  }
} catch (e) {
  process.stderr.write(e.message + '\n');
  process.exit(1);
}
